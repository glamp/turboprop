# Step 000040: Analyze and Plan DuckDB FTS Compatibility Issues

## Overview

Investigate and plan fixes for the DuckDB full-text search (FTS) compatibility issues. The current code uses PostgreSQL-style FTS functions (`to_tsvector`, `gin` indexes) which don't exist in DuckDB, causing FTS index creation to fail.

## Problem Analysis

The error occurs in `database_manager.py` when creating FTS indexes:
```
Catalog Error: Scalar Function with name to_tsvector does not exist!
```

The problematic code in `database_manager.py:576`:
```python
index_sql = (
    f"CREATE INDEX IF NOT EXISTS idx_{fts_table_name}_content "
    f"ON {fts_table_name} USING gin(to_tsvector('english', content))"
)
```

## Root Cause Analysis

1. **PostgreSQL-style FTS**: The code uses PostgreSQL's `to_tsvector()` function and `gin` index type
2. **DuckDB FTS Extension**: DuckDB has its own FTS extension with different syntax and capabilities
3. **Mixed Database Assumptions**: The codebase appears to have been developed with PostgreSQL FTS patterns but is running on DuckDB

## Research Tasks

### 1. DuckDB FTS Extension Investigation

Research DuckDB's full-text search capabilities:
- Available FTS extensions (`fts` extension)
- Syntax differences from PostgreSQL
- Performance characteristics
- Feature parity analysis

### 2. Current FTS Usage Audit

Identify all locations using PostgreSQL-style FTS:
- Search for `to_tsvector` usage
- Search for `gin` index usage  
- Search for other PostgreSQL FTS functions (`ts_rank`, `plainto_tsquery`, etc.)
- Identify fallback behavior when FTS fails

### 3. DuckDB FTS Implementation Planning

Plan the DuckDB-compatible implementation:
- Evaluate DuckDB FTS extension requirements
- Design migration strategy for existing indexes
- Plan backward compatibility approach
- Design graceful degradation when FTS is unavailable

## Investigation Results (To Be Completed)

### DuckDB FTS Extension Details

- **Extension Name**: `fts` 
- **Installation**: `INSTALL fts; LOAD fts;`
- **Table Creation**: `CREATE VIRTUAL TABLE ... USING fts5(...)`
- **Search Syntax**: Different from PostgreSQL

### Compatibility Matrix

| Feature | PostgreSQL | DuckDB FTS | Status |
|---------|------------|------------|--------|
| Full-text indexing | ✅ `to_tsvector` | ✅ `fts5` | Need migration |
| Index types | ✅ `gin` | ✅ `fts5 virtual table` | Different approach |
| Text search | ✅ `@@` operator | ✅ `MATCH` | Different syntax |
| Ranking | ✅ `ts_rank` | ✅ `rank` | Different function |

## Files Requiring Analysis

1. **`database_manager.py`**: FTS table and index creation
2. **`hybrid_search.py`**: FTS query execution
3. **`search_operations.py`**: Search result formatting with FTS
4. **Test files**: FTS-related tests

## Next Steps Planning

Based on investigation results, plan implementation approach:

1. **Option A - DuckDB FTS Extension**: Migrate to proper DuckDB FTS
2. **Option B - Disable FTS**: Remove FTS functionality temporarily  
3. **Option C - Hybrid Approach**: Conditional FTS based on database type

## Implementation Strategy Recommendation

After investigation, choose the most appropriate approach:
- Prioritize compatibility and reliability
- Ensure graceful fallback when FTS is unavailable
- Minimize disruption to existing search functionality
- Consider performance implications

## Success Criteria

- [ ] Complete understanding of DuckDB FTS capabilities
- [ ] Inventory of all PostgreSQL FTS usage in codebase
- [ ] Clear migration plan with defined approach
- [ ] Identified test cases for FTS functionality
- [ ] Plan for backward compatibility and error handling

## Dependencies

- Research access to DuckDB documentation and FTS extension details
- Understanding of current hybrid search architecture

## Estimated Effort

Medium - requires research, analysis, and architectural planning before implementation.